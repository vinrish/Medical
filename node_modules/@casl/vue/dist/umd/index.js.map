{"version":3,"file":"index.js","sources":["../../src/component/can.ts","../../src/plugin.ts"],"sourcesContent":["import Vue, { VNode } from 'vue';\nimport { SubjectType, Generics, AnyAbility, Abilities, IfString, AbilityTuple } from '@casl/ability';\nimport { VueAbility } from '../types';\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\nexport type AllCanProps<T extends AnyAbility> = AbilityCanProps<Generics<T>['abilities']> & {\n  not?: boolean,\n  passThrough?: boolean\n};\n\nexport default Vue.extend<AllCanProps<VueAbility>>({\n  name: 'Can',\n  functional: true,\n  props: {\n    I: String,\n    do: String,\n    a: [String, Function],\n    an: [String, Function],\n    this: [String, Function, Object],\n    on: [String, Function, Object],\n    not: Boolean,\n    passThrough: Boolean,\n    field: String\n  },\n  render(h, { props, children, parent, data }): VNode | VNode[] {\n    const mixed = props as any;\n    const action = mixed.I || mixed.do;\n    const subject = mixed.of || mixed.an || mixed.a || mixed.this || mixed.on;\n\n    if (!action) {\n      throw new Error('[Vue Can]: neither `I` nor `do` prop was passed in <Can>');\n    }\n\n    const isAllowed = parent.$can(action, subject, mixed.field);\n    const canRender = props.not ? !isAllowed : isAllowed;\n\n    if (!props.passThrough) {\n      return canRender ? children : [];\n    }\n\n    if (!data.scopedSlots || !data.scopedSlots.default) {\n      throw new Error('[Vue Can]: `passThrough` expects default scoped slot to be specified');\n    }\n\n    return data.scopedSlots.default({\n      allowed: canRender,\n      ability: parent.$ability,\n    }) as VNode;\n  }\n});\n","import { VueConstructor } from 'vue';\nimport { VueAbility } from './types';\n\nconst WATCHERS = new WeakMap();\n\nfunction renderingDependencyFor(Vue: VueConstructor, ability: VueAbility) {\n  if (WATCHERS.has(ability)) {\n    return WATCHERS.get(ability);\n  }\n\n  const data = { _touch: true }; // eslint-disable-line no-underscore-dangle\n  const watcher = typeof Vue.observable === 'function'\n    ? Vue.observable(data)\n    : new Vue({ data });\n\n  ability.on('updated', () => {\n    // eslint-disable-next-line no-underscore-dangle\n    watcher._touch = !watcher._touch;\n  });\n  WATCHERS.set(ability, watcher);\n\n  return watcher;\n}\n\nfunction abilityDescriptor(ability?: VueAbility) {\n  if (ability) {\n    return { value: ability };\n  }\n\n  return {\n    get() {\n      throw new Error('Please provide `Ability` instance either in `abilitiesPlugin` or in ComponentOptions');\n    }\n  };\n}\n\nexport function abilitiesPlugin(Vue: VueConstructor, defaultAbility?: VueAbility) {\n  Object.defineProperty(Vue.prototype, '$ability', abilityDescriptor(defaultAbility));\n\n  Vue.mixin({\n    beforeCreate() {\n      const { ability, parent } = this.$options;\n      const localAbility = ability || (parent ? parent.$ability : null);\n\n      if (localAbility) {\n        Object.defineProperty(this, '$ability', { value: localAbility });\n      }\n    },\n\n    methods: {\n      $can(...args: any): boolean {\n        const dep = renderingDependencyFor(Vue, this.$ability);\n        dep._touch = dep._touch; // eslint-disable-line\n        return this.$ability.can(...args);\n      }\n    }\n  });\n}\n"],"names":["Vue","extend","name","functional","props","I","String","do","a","Function","an","this","Object","on","not","Boolean","passThrough","field","render","h","children","parent","data","mixed","action","subject","of","Error","isAllowed","$can","canRender","scopedSlots","default","allowed","ability","$ability","WATCHERS","WeakMap","renderingDependencyFor","has","get","_touch","watcher","observable","set","abilityDescriptor","value","abilitiesPlugin","defaultAbility","defineProperty","prototype","mixin","beforeCreate","$options","localAbility","methods","dep","can"],"mappings":"kYAmBeA,aAAIC,OAAgC,CACjDC,KAAM,MACNC,WAAY,KACZC,MAAO,CACLC,EAAGC,OACHC,GAAID,OACJE,EAAG,CAACF,OAAQG,UACZC,GAAI,CAACJ,OAAQG,UACbE,KAAM,CAACL,OAAQG,SAAUG,QACzBC,GAAI,CAACP,OAAQG,SAAUG,QACvBE,IAAKC,QACLC,YAAaD,QACbE,MAAOX,QAETY,kBAAOC,SAAKf,IAAAA,MAAOgB,IAAAA,SAAUC,IAAAA,OAAQC,IAAAA,SAC7BC,EAAQnB,MACRoB,EAASD,EAAMlB,GAAKkB,EAAMhB,OAC1BkB,EAAUF,EAAMG,IAAMH,EAAMb,IAAMa,EAAMf,GAAKe,EAAMZ,MAAQY,EAAMV,OAElEW,QACG,IAAIG,MAAM,gEAGZC,EAAYP,EAAOQ,KAAKL,EAAQC,EAASF,EAAMN,WAC/Ca,EAAY1B,EAAMU,KAAOc,EAAYA,MAEtCxB,EAAMY,mBACFc,EAAYV,EAAW,OAG3BE,EAAKS,cAAgBT,EAAKS,YAAYC,cACnC,IAAIL,MAAM,+EAGXL,EAAKS,YAAYC,QAAQ,CAC9BC,QAASH,EACTI,QAASb,EAAOc,cCpDtB,IAAMC,EAAW,IAAIC,QAErB,SAASC,EAAuBtC,EAAqBkC,MAC/CE,EAASG,IAAIL,UACRE,EAASI,IAAIN,OAGhBZ,EAAO,CAAEmB,EAAQ,UACjBC,EAAoC,oBAAnB1C,EAAI2C,WACvB3C,EAAI2C,WAAWrB,GACf,IAAItB,EAAI,CAAEsB,KAAAA,IAEdY,EAAQrB,GAAG,WAAW,WAEpB6B,EAAQD,GAAUC,EAAQD,KAE5BL,EAASQ,IAAIV,EAASQ,UAEfA,EAGT,SAASG,EAAkBX,MACrBA,QACK,CAAEY,MAAOZ,SAGX,CACLM,uBACQ,IAAIb,MAAM,0FAKf,SAASoB,EAAgB/C,EAAqBgD,GACnDpC,OAAOqC,eAAejD,EAAIkD,UAAW,WAAYL,EAAkBG,IAEnEhD,EAAImD,MAAM,CACRC,gCAC8BzC,KAAK0C,SAAzBnB,IAAAA,QAASb,IAAAA,WACXiC,EAAepB,IAAYb,EAASA,EAAOc,SAAW,SAExDmB,EACF1C,OAAOqC,eAAetC,KAAM,WAAY,CAAEmC,MAAOQ,KAIrDC,QAAS,CACP1B,4BACQ2B,EAAMlB,EAAuBtC,EAAKW,KAAKwB,UAC7CqB,EAAIf,EAASe,EAAIf,gBACLN,UAASsB"}